// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?  // Nullable for OAuth users
  image     String?
  provider  String   @default("credentials") // "credentials" or "google"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  onboarding      UserOnboarding?
  careerGoals     CareerGoal[]
  jobApplications JobApplication[]
  actionItems     ActionItem[]
  careerPlans     CareerPlan[]
  userSkills      UserSkill[]
  milestones      CareerMilestone[]
  conversations   Conversation[]

  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Indexes for better query performance
  @@index([token]) // Already covered by unique, but explicit index
  @@index([email]) // For finding tokens by email
  @@index([expiresAt]) // For cleanup queries
  @@index([createdAt]) // For sorting tokens

  @@map("password_reset_tokens")
}

model UserOnboarding {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  yearsExperience   Int?
  industry          String?
  currentRole       String?

  // Key insights
  biggestStressor   String?  // burnout, pay, growth, bad manager, etc.
  topConstraint     String?  // time, money, location, visa, family, etc.
  careerGoals       String?  // What they want to achieve
  preferredWorkStyle String? // remote, hybrid, onsite

  // AI customization
  skillLevel        String?  // junior, mid, senior, executive
  learningStyle     String?  // structured, exploratory, hands-on

  completed         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([completed])

  @@map("user_onboardings")
}

model CareerGoal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  goalType    String   // clarify-roles, negotiation, handle-manager, career-change, etc.

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  conversations Conversation[]

  @@index([userId])
  @@index([goalType])
  @@index([isActive])

  @@map("career_goals")
}

model Conversation {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  goalId      String?  // Link to career goal if applicable
  goal        CareerGoal? @relation(fields: [goalId], references: [id])

  // AI context
  resumeText  String?
  ventText    String?
  sessionType String?  // template type used

  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  messages    ConversationMessage[]
  tags        ConversationTag[]

  @@index([userId])
  @@index([goalId])
  @@index([sessionType])
  @@index([isArchived])
  @@index([createdAt])

  @@map("conversations")
}

model ConversationMessage {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  content         String
  role            String   // user, assistant
  timestamp       DateTime @default(now())

  // AI tool usage
  toolCalls       Json?
  toolResults     Json?

  @@index([conversationId])
  @@index([timestamp])

  @@map("conversation_messages")
}

model ConversationTag {
  id            String   @id @default(cuid())
  conversationId String
  conversation  Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  tag           String   // burnout, salary, career-change, tech, etc.

  @@index([conversationId])
  @@index([tag])

  @@map("conversation_tags")
}

model JobApplication {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  company       String
  role          String
  jobUrl        String?
  jobBoard      String?  // LinkedIn, Indeed, company website, etc.

  status        String   @default("wishlist") // wishlist, applied, interview, offer, rejected
  appliedDate   DateTime?
  nextActionDate DateTime?
  nextAction    String?

  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([appliedDate])
  @@index([nextActionDate])

  @@map("job_applications")
}

model ActionItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  status      String   @default("pending") // pending, in-progress, completed, cancelled

  priority    String   @default("medium") // low, medium, high
  dueDate     DateTime?

  // Source tracking
  sourceType  String?  // conversation, job-application, manual, ai-suggestion
  sourceId    String?  // ID of the source (conversation ID, job application ID, etc.)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([sourceType])
  @@index([sourceId])

  @@map("action_items")
}

model CareerPlan {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  duration    String   @default("90") // 30, 60, 90 days

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  phases      CareerPlanPhase[]

  @@index([userId])
  @@index([isActive])

  @@map("career_plans")
}

model CareerPlanPhase {
  id          String   @id @default(cuid())
  planId      String
  plan        CareerPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  title       String
  description String?
  weekRange   String   // "1-2", "3-4", etc.
  order       Int

  createdAt   DateTime @default(now())

  // Relations
  tasks       CareerPlanTask[]

  @@index([planId])
  @@index([order])

  @@map("career_plan_phases")
}

model CareerPlanTask {
  id          String   @id @default(cuid())
  phaseId     String
  phase       CareerPlanPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  isCompleted Boolean  @default(false)

  order       Int
  createdAt   DateTime @default(now())

  @@index([phaseId])
  @@index([isCompleted])
  @@index([order])

  @@map("career_plan_tasks")
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  skillName   String
  category    String   // technical, leadership, communication, product, data, etc.
  confidence  Int      // 1-5 scale

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@unique([userId, skillName])

  @@map("user_skills")
}

model CareerMilestone {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  milestoneType String   // clarified-roles, updated-resume, first-application, etc.
  title         String
  description   String?

  isCompleted   Boolean  @default(false)
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([milestoneType])
  @@index([isCompleted])

  @@map("career_milestones")
}

model SessionTemplate {
  id          String   @id @default(cuid())

  title       String
  description String
  category    String   // lost, performance-review, toxic-environment, transition, etc.

  // Template configuration
  suggestedPrompt String?

  // Sample content
  sampleResponse Json? // Sample AI response structure

  isPublic     Boolean @default(true)
  createdAt    DateTime @default(now())

  @@index([category])
  @@index([isPublic])

  @@map("session_templates")
}